"use strict";var app;(app=app||{}).util={copyCoordinate:function(e){return{x:e.x,y:e.y}},isCoordinateInMovementSquares:function(e,t){for(var n=0;n<t.length;n++){var a=t[n];if(e.x===a.x&&e.y===a.y)return!0}return!1},areCoordinatesEqual:function(e,t){return e.x===t.x&&e.y===t.y},coordinateFrom:function(e,t){return{x:e,y:t}},getJson:function(e,t){var n,a,r,o,i,u;window.fetch?(o=t,i=new Request(e),(u=new Headers).append("Content-Type","application/json"),fetch(i,{headers:u}).then(function(e){return e.json()}).then(function(e){o(e)})):(n=e,a=t,(r=new XMLHttpRequest).overrideMimeType("application/json"),r.onreadystatechange=function(){if(r.readyState===XMLHttpRequest.DONE){var e=r.response;e=JSON.parse(e),r.status<=200&&r.status<300&&a(e)}},r.open("GET",n,!0),r.send())},forEach:function(e,t){return Array.prototype.forEach.call(e,t)},cloneObject:function(e){return JSON.parse(JSON.stringify(e))}},(app=app||{}).templater={createElement:function(e,t,n){var a=document.createElement(e);return t&&(a.textContent=t),n&&(a.className=n),a}},(app=app||{}).uiStats={get:function(){var e={},t=document.getElementById("cursor_sprite");return e.cursor={select:{spritesheet:t,spriteCoordinate:{x:1,y:0}},attack:{spritesheet:t,spriteCoordinate:{x:0,y:0}}},e}},function(n){var e=function(e){return document.querySelectorAll(e)},a=e(".nav-list li"),r=e(".tab[data-tab]");function t(e){n.forEach(a,function(e){e.classList.remove("active")}),e.classList.add("active");var t=e.dataset.tab;n.forEach(r,function(e){e.classList.remove("active")}),document.querySelector('.tab[data-tab="'+t+'"]').classList.add("active")}n.forEach(a,function(e){e.onclick=function(){t(e)}}),t(a[0])}(app.util),(app=app||{}).modal=function(){var n=document.getElementById("modal-text-container"),a=document.getElementById("modal-button-ok"),e=document.getElementById("modal-button-cancel"),r=document.getElementById("modal-window"),o=document.getElementById("modal-text-input");function i(){document.documentElement.classList.add("show-modal")}function u(){document.documentElement.classList.remove("show-modal")}function l(){r.classList.remove("prompt"),r.classList.remove("alert"),a.classList.remove("btn-default"),a.classList.remove("btn-danger"),a.classList.remove("btn-primary"),o.value=null}return e.onclick=function(){u()},{alert:function(e){l(),r.classList.add("alert"),a.classList.add("btn-default"),n.textContent=e,a.onclick=function(){u()},i()},confirm:function(e,t){l(),a.classList.add("btn-danger"),n.textContent=e,a.onclick=function(){u(),t()},i()},prompt:function(e,t){l(),r.classList.add("prompt"),a.classList.add("btn-primary"),n.textContent=e,a.onclick=function(){u(),t(o.value)},i()}}}(),(app=app||{}).textOverlay=function(){var a=document.getElementById("text-overlay-container"),r=document.getElementById("text-overlay-heading"),o=document.getElementById("text-overlay-button");function i(){a.classList.remove("show-heading-animation"),a.classList.remove("show-menu"),r.textContent=""}function u(){document.documentElement.classList.add("show-text-overlay")}function l(){document.documentElement.classList.remove("show-text-overlay")}return{displayHeading:function(e,t,n){n=n||function(){},i(),a.classList.add("show-heading-animation"),r.textContent=e,u(),t&&0<t?setTimeout(function(){l(),n()},t):(l(),n())},displayMenu:function(e,t,n){i(),a.classList.add("show-menu"),r.textContent=e,o.textContent=t,o.onclick=function(){l(),n()},u()}}}(),(app=app||{}).damage=function(){function i(e,t,n,a,r,o){var i=r[e.type],u=r[t.type],l=o[a.type],s=i.attackTable[t.type];return 1==u.applyDefense&&1==l.defense?Math.floor(.5*s):s}return{damageForAttack:i,damageForCounterattack:function(e,t,n,a,r,o){return Math.floor(.5*i(e,t,0,a,r,o))}}}(),(app=app||{}).terrainStats={get:function(){var e=[];return e.push({name:"Grass",defense:!1}),e.push({name:"Mountains",defense:!0}),e.push({name:"Trees",defense:!0}),e.push({name:"Water",defense:!1}),e.push({name:"Edge of water",defense:!1}),e.push({name:"Bridge",defense:!1}),e.push({name:"Sand",defense:!1}),e.push({name:"Deep Water",defense:!1}),e},create:function(e){return{type:e}}},(app=app||{}).unitStats=function(){var n={RIGHT:0,LEFT:1,UP:2,DOWN:3};function a(){var e=[];return e.push({name:"Infantry",spritesheets:[document.getElementById("soldier_red_sprite"),document.getElementById("soldier_blue_sprite")],spriteCoordinates:[[{x:0,y:0},{x:1,y:0}],[{x:0,y:0},{x:1,y:0}]],spriteCoordinatesWhenMoved:[[{x:2,y:0},{x:3,y:0}],[{x:2,y:0},{x:3,y:0}]],canTraverse:[!0,!0,!0,!0,!0,!0,!0,!1],applyDefense:!0,hitpoints:75,attackTable:[30,20,40],movementSpeed:6}),e.push({name:"Tank",spritesheets:[document.getElementById("tank_red_sprite"),document.getElementById("tank_blue_sprite")],spriteCoordinates:[[{x:0,y:0},{x:1,y:0}],[{x:0,y:0},{x:1,y:0}]],spriteCoordinatesWhenMoved:[[{x:2,y:0},{x:3,y:0}],[{x:2,y:0},{x:3,y:0}]],canTraverse:[!0,!1,!1,!1,!0,!0,!0,!1],applyDefense:!1,hitpoints:150,attackTable:[50,40,30],movementSpeed:4}),e.push({name:"Plane",spritesheets:[document.getElementById("plane_red_sprite"),document.getElementById("plane_blue_sprite")],spriteCoordinates:[[{x:0,y:0},{x:1,y:0}],[{x:0,y:0},{x:1,y:0}]],spriteCoordinatesWhenMoved:[[{x:2,y:0},{x:3,y:0}],[{x:2,y:0},{x:3,y:0}]],canTraverse:[!0,!0,!0,!0,!0,!0,!0,!0],applyDefense:!1,hitpoints:100,attackTable:[20,50,30],movementSpeed:8}),e}return{get:a,create:function(e,t){return{type:e,team:t,health:a()[e].hitpoints,canMove:!0,currentDirection:n.LEFT}},UNIT_DIRECTIONS:n,TEAMS:{PLAYER:0,AI:1}}}(),(app=app||{}).animationStats={get:function(){var e={};return e.explosion={name:"Explosion",type:"static animation",spritesheet:document.getElementById("explosion_spritesheet"),spriteCoordinates:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},{x:5,y:0},{x:6,y:0},{x:7,y:0},{x:8,y:0},{x:9,y:0},{x:10,y:0},{x:11,y:0}]},e.unitDamage={name:"Unit damage",type:"static color animation",colorCells:["rgba(255,0,0, 0.1)","rgba(255,0,0, 0.3)","rgba(255,0,0, 0.3)","rgba(255,0,0, 0.5)","rgba(255,0,0, 0.7)","rgba(255,0,0, 8.0)","rgba(255,0,0, 0.7)","rgba(255,0,0, 0.5)","rgba(255,0,0, 0.3)","rgba(255,0,0, 0.3)","rgba(255,0,0, 0.1)"]},e.unitAttack=[{name:"Infantry",type:"static animation",spritesheet:document.getElementById("soldier_attack_sprite"),spriteCoordinates:[[{x:0,y:0},{x:1,y:0},{x:3,y:0},{x:3,y:0},{x:3,y:0},{x:3,y:0},{x:0,y:0},{x:1,y:0},{x:3,y:0},{x:3,y:0},{x:3,y:0},{x:3,y:0}],[{x:2,y:0},{x:4,y:0},{x:5,y:0},{x:5,y:0},{x:5,y:0},{x:5,y:0},{x:2,y:0},{x:4,y:0},{x:5,y:0},{x:5,y:0},{x:5,y:0},{x:5,y:0}]]},{name:"Tank",type:"static animation",spritesheet:document.getElementById("tank_attack_sprite"),spriteCoordinates:[[{x:0,y:0},{x:1,y:0},{x:1,y:0},{x:2,y:0},{x:2,y:0},{x:2,y:0},{x:2,y:0},{x:2,y:0}],[{x:3,y:0},{x:4,y:0},{x:4,y:0},{x:5,y:0},{x:5,y:0},{x:5,y:0},{x:5,y:0},{x:5,y:0}]]},{name:"Plane",type:"static animation",spritesheet:document.getElementById("plane_attack_sprite"),spriteCoordinates:[[{x:0,y:0},{x:1,y:0},{x:1,y:0},{x:2,y:0},{x:2,y:0},{x:2,y:0}],[{x:3,y:0},{x:4,y:0},{x:4,y:0},{x:5,y:0},{x:5,y:0},{x:5,y:0}]]}],e}},(app=app||{}).levelStats={get:function(){var e=[];return e.push({name:"Level 0",spritesheet:document.getElementById("level1_sprite"),dataUnitsUrls:["data/level1sprites.json","data/level1spriteshard.json"],dataUnits:[],dataTerrainUrl:"data/level1.json",dataTerrain:null}),e.push({name:"Level 1",spritesheet:document.getElementById("level2_sprite"),dataUnitsUrls:["data/level2sprites.json","data/level2spriteshard.json"],dataUnits:[],dataTerrainUrl:"data/level2.json",dataTerrain:null}),e.push({name:"Level 2",spritesheet:document.getElementById("level3_sprite"),dataUnitsUrls:["data/level3sprites.json","data/level3spriteshard.json"],dataUnits:[],dataTerrainUrl:"data/level3.json",dataTerrain:null}),e}},(app=app||{}).levelLoader=function(o,t){function l(e){switch(e){case 3:case 4:case 5:case 19:case 20:case 21:case 35:case 36:case 37:return t.create(6);case 472:case 473:case 488:case 489:case 504:case 505:return t.create(2);case 53:case 69:case 85:return t.create(3);case 52:case 54:case 68:case 70:case 84:case 86:return t.create(4);case 23:return t.create(7);case 365:case 381:case 397:return t.create(5);case 460:case 476:return t.create(1);default:return t.create(0)}}return{unitFor:function(e,t,n,a){if(void 0===e.units[t]||void 0===e.units[t][n])return null;var r;switch(e.units[t][n]){case 1:r=o.create(0,0);break;case 2:r=o.create(1,0);break;case 3:r=o.create(2,0);break;case 4:r=o.create(0,1);break;case 5:r=o.create(1,1);break;case 6:r=o.create(2,1);break;default:r=null}return null===r||(n<a.x/2?r.currentDirection=o.UNIT_DIRECTIONS.RIGHT:r.currentDirection=o.UNIT_DIRECTIONS.LEFT),r},terrainFor:function(e,t,n,a){var r=e.dataTerrain.layers,o=a.x*n+t,i=r[1].data[o],u=r[0].data[o];return l(0!==i?i:u)},initializeLevelData:function(e,n,a){e.forEach(function(e,t){n[t]&&(e.dataUnits=n[t]),a[t]&&(e.dataTerrain=a[t])})}}}(app.unitStats,app.terrainStats),(app=app||{}).audioStats={get:function(){var e={units:[]};return e.units.push({name:"Infantry",attackUrl:"sounds/soldierAttackShort.ogg",moveUrl:"sounds/soldierMove.ogg",damageUrl:"",dieUrl:"sounds/death.ogg",move:null,attack:null,damage:null,die:null}),e.units.push({name:"Tank",attackUrl:"sounds/tankAttack.ogg",moveUrl:"sounds/tankMove.ogg",damageUrl:"",dieUrl:"sounds/death.ogg",move:null,attack:null,damage:null,die:null}),e.units.push({name:"Plane",attackUrl:"sounds/planeAttack.ogg",moveUrl:"sounds/planeMove.ogg",damageUrl:"",dieUrl:"sounds/death.ogg",move:null,attack:null,damage:null,die:null}),e.level={passed:{url:"sounds/levelComplete.ogg",audio:null},failed:{url:"sounds/levelFailure.ogg",audio:null}},e.cursor={select:{url:"sounds/select.ogg",audio:null},deselect:{url:"sounds/deselect.ogg",audio:null}},e.music=[{url:"sounds/ready-steady-stinger.ogg",audio:null},{url:"sounds/panic-attack-stinger.ogg",audio:null},{url:"sounds/marche-grotesque-stinger.ogg",audio:null},{url:"sounds/visions-of-apocalypse-stinger.ogg",audio:null}],e}},(app=app||{}).mixer=function(){var u=new(window.AudioContext||window.webkitAudioContext);function l(t,e){if(null!==t)if(e){var n=10,a=100/(e/n)/100;t.gain.value=t.gain.value-a,function e(){setTimeout(function(){t.gain.value=t.gain.value-a,0<t.gain.value?e():t.disconnect()},n)}()}else t.disconnect()}return{getAudioBuffer:function e(t,n,a){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){u.decodeAudioData(r.response,function(e){n(e)},function(){a?n(null):e(t.replace(/ogg$/,"aac"),n,!0)})},r.send()},playAudioBuffer:function(e,t,n,a){if(null===e)return null;function r(e){setTimeout(function(){l(e,2e3)},a)}var o=u.createBufferSource();o.buffer=e,t&&(o.loop=!0);var i=u.createGain();return o.connect(i),i.connect(u.destination),n&&0<n?setTimeout(function(){o.start(0),a&&0<a&&r(i)},n):(o.start(0),a&&0<a&&r(i)),i},stopSound:l}}(),(app=app||{}).renderer=function(m,r,e,t){var p=r.get(),g=(e.get(),t.get()),o={RIGHT:0,LEFT:1,UP:2,DOWN:3},E=32,x=2,v=10,S=200;function T(e){return{x:e.x*E,y:e.y*E}}function l(e,t){return t[e.x][e.y]}function i(e,t){t.width=e.offsetWidth,t.height=e.offsetHeight}function h(e,t,n,a){var r=T(a);e.drawImage(t,r.x,r.y,E,E,n.x,n.y,E,E)}function s(e,t,n,a){h(e,t,T(n),a)}function C(e,t){e.clearRect(t.x,t.y,E,E)}function I(e,t){C(e,T(t))}function k(e,t,n){I(e,t),n.health<=0||(n.canMove?c(e,t,n):a(e,t,n))}function a(e,t,n){var a=p[n.type];s(e,a.spritesheets[n.team],t,a.spriteCoordinatesWhenMoved[n.team][n.currentDirection]),u(e,t,n)}function c(e,t,n){var a=p[n.type];s(e,a.spritesheets[n.team],t,a.spriteCoordinates[n.team][n.currentDirection]),u(e,t,n)}function b(e,t,n){var a=n.health/p[n.type].hitpoints;if(!(1<=a)){var r=E-4;e.fillStyle="tomato",e.fillRect(t.x+2,t.y+4,r,2),e.fillStyle="lawngreen",e.fillRect(t.x+2,t.y+4,r*a,2)}}function u(e,t,n){b(e,T(t),n)}function n(n,e,a){n.beginPath(),e.forEach(function(e){var t=T(e);n.fillStyle=a,n.rect(t.x,t.y,E,E)}),n.fill()}function M(e,t,n){var a;return t.x<e.x?(a=o.LEFT,n.currentDirection=r.UNIT_DIRECTIONS.LEFT):t.y>e.y?(a=o.DOWN,p[n.type].spriteCoordinates[n.team][r.UNIT_DIRECTIONS.DOWN]&&(n.currentDirection=r.UNIT_DIRECTIONS.DOWN)):t.y<e.y?(a=o.UP,p[n.type].spriteCoordinates[n.team][r.UNIT_DIRECTIONS.UP]&&(n.currentDirection=r.UNIT_DIRECTIONS.UP)):(a=o.RIGHT,n.currentDirection=r.UNIT_DIRECTIONS.RIGHT),a}function d(i,u,e,t,l){var s={RIGHT:0,LEFT:1,UP:2,DOWN:3},c=null,n=T(e),d=T(t),y=m.copyCoordinate(n),f=M(e,t,u);window.requestAnimationFrame(function e(t){if(null===c&&(c=t),t-c<v)window.requestAnimationFrame(e);else{switch(C(i,y),f){case s.UP:y.y-=x;break;case s.LEFT:y.x-=x;break;case s.RIGHT:y.x+=x;break;default:y.y+=x}var n,a,r,o;n=i,a=y,o=p[(r=u).type],h(n,o.spritesheets[r.team],a,o.spriteCoordinates[r.team][r.currentDirection]),b(n,a,r),m.areCoordinatesEqual(y,d)?l():(c=null,window.requestAnimationFrame(e))}})}function A(n,a,r,o){var i=0,u=null;window.requestAnimationFrame(function e(t){null===u&&(u=t),t-u<S?window.requestAnimationFrame(e):(I(n,r),i<a.spriteCoordinates.length?(s(n,a.spritesheet,r,a.spriteCoordinates[i]),i++,window.requestAnimationFrame(e)):o())})}return{TILE_SIZE:E,totalTiles:function(e){return{x:Math.floor(e.offsetWidth/E),y:Math.floor(e.offsetHeight/E)}},setCanvasDimensions:i,getContext:function(e,t){var n=document.getElementById(t),a=n.getContext("2d");return i(e,n),a},tileCoordinateToPixelCoordinate:T,pixelCoordinateToTileCoordinate:function(e){return{x:Math.floor(e.x/E),y:Math.floor(e.y/E)}},drawTile:s,eraseTile:I,eraseCanvas:function(e){e.clearRect(0,0,e.canvas.width,e.canvas.height)},renderInitialGameboard:function(e,t){for(var n=e.length,a=0;a<n;a++)for(var r=e[a].length,o=0;o<r;o++){var i={x:a,y:o},u=l(i,e);u.unit&&k(t,i,u.unit)}},gameTileForCoordinate:l,renderUnitSelectionOutline:function(e,t){var n=T(t);e.strokeStyle="rgb(0,255,0)",e.lineWidth=2,e.strokeRect(n.x,n.y,E,E)},renderUnitMovementSquares:function(e,t){n(e,t,"rgba(0,0,255, 0.5)")},renderUnitAttackSquares:function(e,t){n(e,t,"rgba(255,0,0, 0.3)")},renderLevel:function(e,t){e.drawImage(t,0,0)},renderUnitMovement:function(t,n,a,r,o){var e=r[0];function i(){var e=r[r.length-1];c(t,e,a),I(n,e),o()}c(n,e,a),I(t,e);var u=0;1<r.length?d(n,a,r[0],r[1],function e(){++u<r.length-1?d(n,a,r[u],r[u+1],e):i()}):i()},renderUnitMovementPreview:function(n,e){n.beginPath(),e.forEach(function(e){var t=T(e);I(n,e),n.fillStyle="rgba(0,255,178,0.5)",n.rect(t.x,t.y,E,E)}),n.fill()},renderUnitMoved:a,renderUnit:c,redrawUnit:k,renderAttack:function(e,t,n,a,r,o,i,u){function l(){k(e,a,o),o.health<=0?A(t,g.explosion,a,u):u()}M(n,a,r),k(e,n,r);var s,c,d,y,f,m,p,x=2,v=g.unitAttack[r.type],h={spritesheet:v.spritesheet,spriteCoordinates:v.spriteCoordinates[r.currentDirection]};A(t,h,n,function(){--x<=0&&l()}),s=t,c=g.unitDamage,y=function(){--x<=0&&l()},f=T(d=a),m=0,p=null,window.requestAnimationFrame(function e(t){null===p&&(p=t);var n=t-p;n<S?window.requestAnimationFrame(e):(I(s,d),m<c.colorCells.length?(s.fillStyle=c.colorCells[m],s.fillRect(f.x,f.y,E,E),m++,window.requestAnimationFrame(e)):y())})}}}(app.util,app.unitStats,app.terrainStats,app.animationStats),(app=app||{}).pathfinder=function(c){function d(e,t,n,a){var r=n[t[e.x][e.y].unit.type],o=t[1][2].terrain;r.canTraverse[o.type];var i=t[0].length-1,u=t.length-1,l=[];e.x+1<=u&&r.canTraverse[t[e.x+1][e.y].terrain.type]&&null===t[e.x+1][e.y].unit&&l.push({x:e.x+1,y:e.y,cost:1,fromX:e.x,fromY:e.y}),0<=e.x-1&&r.canTraverse[t[e.x-1][e.y].terrain.type]&&null===t[e.x-1][e.y].unit&&l.push({x:e.x-1,y:e.y,cost:1,fromX:e.x,fromY:e.y}),e.y+1<=i&&r.canTraverse[t[e.x][e.y+1].terrain.type]&&null===t[e.x][e.y+1].unit&&l.push({x:e.x,y:e.y+1,cost:1,fromX:e.x,fromY:e.y}),0<=e.y-1&&r.canTraverse[t[e.x][e.y-1].terrain.type]&&null===t[e.x][e.y-1].unit&&l.push({x:e.x,y:e.y-1,cost:1,fromX:e.x,fromY:e.y});for(var s=1,c=0;s<=r.movementSpeed&&c<l.length;)l[c].x+1<=u&&r.canTraverse[t[l[c].x+1][l[c].y].terrain.type]&&!m(l,l[c].x+1,l[c].y)&&null===t[l[c].x+1][l[c].y].unit&&l.push({x:l[c].x+1,y:l[c].y,cost:l[c].cost+1,fromX:l[c].x,fromY:l[c].y}),0<=l[c].x-1&&r.canTraverse[t[l[c].x-1][l[c].y].terrain.type]&&!m(l,l[c].x-1,l[c].y)&&null===t[l[c].x-1][l[c].y].unit&&l.push({x:l[c].x-1,y:l[c].y,cost:l[c].cost+1,fromX:l[c].x,fromY:l[c].y}),l[c].y+1<=i&&r.canTraverse[t[l[c].x][l[c].y+1].terrain.type]&&!m(l,l[c].x,l[c].y+1)&&null===t[l[c].x][l[c].y+1].unit&&l.push({x:l[c].x,y:l[c].y+1,cost:l[c].cost+1,fromX:l[c].x,fromY:l[c].y}),0<=l[c].y-1&&r.canTraverse[t[l[c].x][l[c].y-1].terrain.type]&&!m(l,l[c].x,l[c].y-1)&&null===t[l[c].x][l[c].y-1].unit&&l.push({x:l[c].x,y:l[c].y-1,cost:l[c].cost+1,fromX:l[c].x,fromY:l[c].y}),++c<l.length&&(s=l[c].cost+1);return l}function y(e,t,n,a){var r=n[t[e.x][e.y].unit.type],o=t[1][2].terrain;r.canTraverse[o.type];var i=t[0].length-1,u=t.length-1,l=[];e.x+1<=u&&r.canTraverse[t[e.x+1][e.y].terrain.type]&&null===t[e.x+1][e.y].unit&&l.push({x:e.x+1,y:e.y,cost:1,fromX:e.x,fromY:e.y}),0<=e.x-1&&r.canTraverse[t[e.x-1][e.y].terrain.type]&&null===t[e.x-1][e.y].unit&&l.push({x:e.x-1,y:e.y,cost:1,fromX:e.x,fromY:e.y}),e.y+1<=i&&r.canTraverse[t[e.x][e.y+1].terrain.type]&&null===t[e.x][e.y+1].unit&&l.push({x:e.x,y:e.y+1,cost:1,fromX:e.x,fromY:e.y}),0<=e.y-1&&r.canTraverse[t[e.x][e.y-1].terrain.type]&&null===t[e.x][e.y-1].unit&&l.push({x:e.x,y:e.y-1,cost:1,fromX:e.x,fromY:e.y});for(var s=0;s<l.length-1;){for(var c=f({x:l[s].fromX,y:l[s].fromY},l[s]),d=0+c;d<c+4;d++)d%4==0&&l[s].y+1<=i&&r.canTraverse[t[l[s].x][l[s].y+1].terrain.type]&&!m(l,l[s].x,l[s].y+1)&&null===t[l[s].x][l[s].y+1].unit&&l.push({x:l[s].x,y:l[s].y+1,cost:l[s].cost+1,fromX:l[s].x,fromY:l[s].y}),d%4==1&&0<=l[s].x-1&&r.canTraverse[t[l[s].x-1][l[s].y].terrain.type]&&!m(l,l[s].x-1,l[s].y)&&null===t[l[s].x-1][l[s].y].unit&&l.push({x:l[s].x-1,y:l[s].y,cost:l[s].cost+1,fromX:l[s].x,fromY:l[s].y}),d%4==2&&0<=l[s].y-1&&r.canTraverse[t[l[s].x][l[s].y-1].terrain.type]&&!m(l,l[s].x,l[s].y-1)&&null===t[l[s].x][l[s].y-1].unit&&l.push({x:l[s].x,y:l[s].y-1,cost:l[s].cost+1,fromX:l[s].x,fromY:l[s].y}),d%4==3&&l[s].x+1<=u&&r.canTraverse[t[l[s].x+1][l[s].y].terrain.type]&&!m(l,l[s].x+1,l[s].y)&&null===t[l[s].x+1][l[s].y].unit&&l.push({x:l[s].x+1,y:l[s].y,cost:l[s].cost+1,fromX:l[s].x,fromY:l[s].y});++s<l.length&&l[s].cost+1}return l}function f(e,t){var n=t.x-e.x,a=t.y-e.y;return 0===n&&1===a?1:-1===n&&0===a?2:0===n&&-1===a?3:0}function m(e,t,n){for(var a=0;a<e.length;a++)if(e[a].x==t&&e[a].y==n)return!0;return!1}function p(e,t,n){for(var a=0;a<e.length;a++)if(e[a].x==t&&e[a].y==n)return e[a];return{x:-1,y:-1}}return{movementCoordinatesFor:d,pathFor:function(e,t,n,a,r){a[n[e.x][e.y].unit.type];var o=d(e,n,a),i=[],u=[];if(m(o,t.x,t.y))for(i.push(t);i[i.length-1].x!=e.x||i[i.length-1].y!=e.y;){var l=p(o,i[i.length-1].x,i[i.length-1].y);i.push({x:l.fromX,y:l.fromY})}else u.push({x:e.x,y:e.y+1});for(var s=i.length-1;0<=s;s--)u.push(i[s]);return u},attackCoordinatesFor:function(e,t,n,a){return i=n,u=(o=t)[(r=e).x][r.y].unit,l=[],(s=d(r,o,i)).push(r),s.forEach(function(e){[c.coordinateFrom(e.x+1,e.y),c.coordinateFrom(e.x-1,e.y),c.coordinateFrom(e.x,e.y+1),c.coordinateFrom(e.x,e.y-1)].forEach(function(e){var t;void 0!==o[(t=e).x]&&void 0!==o[t.x][t.y]&&o[t.x][t.y].unit&&o[t.x][t.y].unit.team!==u.team&&l.push(e)})}),l;var r,o,i,u,l,s},AIPathFor:function(e,t,n,a,r){a[n[e.x][e.y].unit.type];var o=y(e,n,a),i=[],u=[],l=[];if(m(o,t.x,t.y)&&l.push({x:t.x,y:t.y,cost:p(o,t.x,t.y).cost}),m(o,t.x+1,t.y)&&l.push({x:t.x+1,y:t.y,cost:p(o,t.x+1,t.y).cost}),m(o,t.x-1,t.y)&&l.push({x:t.x-1,y:t.y,cost:p(o,t.x-1,t.y).cost}),m(o,t.x,t.y+1)&&l.push({x:t.x,y:t.y+1,cost:p(o,t.x,t.y+1).cost}),m(o,t.x,t.y-1)&&l.push({x:t.x,y:t.y-1,cost:p(o,t.x,t.y-1).cost}),0<l.length)var s=l[0];else s=o[0];if(m(o,s.x,s.y))for(i.push(s);i[i.length-1].x!=e.x||i[i.length-1].y!=e.y;){var c=p(o,i[i.length-1].x,i[i.length-1].y);i.push({x:c.fromX,y:c.fromY,cost:c.cost})}else i.push(o[0]),i.push(e);for(var d=i.length-1;0<=d;d--)u.push(i[d]);return u},AIMultiTurnMovements:y,movementCoordinatesForAttackCoordinate:function(a,e){return e.filter(function(e){return n=a,(t=e).x===n.x&&(t.y+1===n.y||t.y-1===n.y)||t.y===n.y&&(t.x+1===n.x||t.x-1===n.x);var t,n})}}}(app.util),(app=app||{}).ai=function(e,E,h,t,S){var r={END_TURN:0,MOVE_UNIT:1,ATTACK_UNIT:2};function T(){return{actionType:r.END_TURN}}function v(e,t,n){return{actionType:r.MOVE_UNIT,startingCoordinate:e,endingCoordinate:t,memoizationObject:n}}function C(e,t,n,a){return{actionType:r.ATTACK_UNIT,startingCoordinate:e,endingCoordinate:t,attackedUnitCoordinate:n,memoizationObject:a}}function g(e,t,n,a,r,o,i){if(void 0!==r.doneMoving&&!0===r.doneMoving)return T();var u=function(e,t,n,a){var r=[];r.push(a);var o=0;for(;o<r.length&&o<20;)0<r[o].x-1&&n[e[r[o].x-1][r[o].y].terrain.type].defense&&(L(r,r[o].x-1,r[o].y)||r.push({x:r[o].x-1,y:r[o].y})),r[o].y+1<e[r[o].x].length&&n[e[r[o].x][r[o].y+1].terrain.type].defense&&(L(r,r[o].x,r[o].y+1)||r.push({x:r[o].x,y:r[o].y+1})),r[o].x+1<e.length&&n[e[r[o].x+1][r[o].y].terrain.type].defense&&(L(r,r[o].x+1,r[o].y)||r.push({x:r[o].x+1,y:r[o].y})),0<r[o].y-1&&n[e[r[o].x][r[o].y-1].terrain.type].defense&&(L(r,r[o].x,r[o].y-1)||r.push({x:r[o].x,y:r[o].y-1})),o++;return r}(e,0,n,function(e,t,n,a){var r=!1,o=a.x,i=a.y,u=0,l=0,s=1;if(n[e[a.x][a.y].terrain.type].defense)return{x:a.x,y:a.y};for(;!r&&s<20;){if(!r)for(var c=0;c<s;c++)if(-1<i+c-s&&i+c-s<e[o].length&&-1<o+c&&o+c<e.length&&n[e[o+c][i+c-s].terrain.type].defense){r=!0,u=o+c,l=i+c-s;break}if(!r)for(var d=0;d<s;d++)if(-1<i+d&&i+d<e[o].length&&-1<o-d+s&&o-d+s<e.length&&n[e[o-d+s][i+d].terrain.type].defense){r=!0,u=o-d+s,l=i+d;break}if(!r)for(var c=0;c<s;c++)if(-1<i-c+s&&i-c+s<e[o].length&&-1<o-c&&o-c<e.length&&n[e[o-c][i-c+s].terrain.type].defense){r=!0,u=o-c,l=i-c+s;break}if(!r)for(var d=0;d<s;d++)if(-1<i-d&&i-d<e[o].length&&-1<o+d-s&&o+d-s<e.length&&n[e[o+d-s][i-d].terrain.type].defense){r=!0,u=o+d-s,l=i-d;break}if(r)break;s+=1}return{x:u,y:l}}(e,0,n,r.AICentroid)),l=function(e,t){for(var n={x:100,y:100},a=n.x*n.x+n.y*n.y,r=0;r<t.length;r++){var o=(t[r].x-e.x)*(t[r].x-e.x)+(t[r].y-e.y)*(t[r].y-e.y);o<a&&(n=t[r],a=o)}var i=L(t,n.x,n.y-1),u=L(t,n.x,n.y+1),l=L(t,n.x-1,n.y),s=L(t,n.x+1,n.y),c=n,d=[];if(u&&s){d=[];for(var y=!0;y;)L(t,c.x,c.y+1)?c={x:c.x,y:c.y+1}:y=!1;for(var f=!0;f;)d.push(c),c={x:c.x,y:c.y-1},L(t,c.x,c.y)||(f=!1);c={x:c.x+1,y:c.y+1};for(var m=!0;m;)d.push(c),c={x:c.x+1,y:c.y},L(t,c.x,c.y)||(m=!1)}if(u&&l){d=[];for(var y=!0;y;)L(t,c.x,c.y+1)?c={x:c.x,y:c.y+1}:y=!1;for(var f=!0;f;)d.push(c),c={x:c.x,y:c.y-1},L(t,c.x,c.y)||(f=!1);c={x:c.x-1,y:c.y+1};for(var p=!0;p;)d.push(c),c={x:c.x-1,y:c.y},L(t,c.x,c.y)||(p=!1)}if(i&&s){d=[];for(var x=!0;x;)L(t,c.x,c.y-1)?c={x:c.x,y:c.y-1}:x=!1;for(var v=!0;v;)d.push(c),c={x:c.x,y:c.y+1},L(t,c.x,c.y)||(v=!1);c={x:c.x+1,y:c.y-1};for(var m=!0;m;)d.push(c),c={x:c.x+1,y:c.y},L(t,c.x,c.y)||(m=!1)}if(i&&l){d=[];for(var x=!0;x;)L(t,c.x,c.y-1)?c={x:c.x,y:c.y-1}:x=!1;for(var v=!0;v;)d.push(c),c={x:c.x,y:c.y+1},L(t,c.x,c.y)||(v=!1);c={x:c.x-1,y:c.y-1};for(var p=!0;p;)d.push(c),c={x:c.x-1,y:c.y},L(t,c.x,c.y)||(p=!1)}var c=n;if(i&&u){d=[];for(var x=!0;x;)L(t,c.x,c.y-1)?c={x:c.x,y:c.y-1}:x=!1;for(var h=!0;h;)d.push(c),c={x:c.x,y:c.y+1},L(t,c.x,c.y)||(h=!1)}if(l&&s){d=[];for(var g=!0;g;)L(t,c.x-1,c.y)?c={x:c.x-1,y:c.y}:g=!1;for(var m=!0;m;)d.push(c),c={x:c.x+1,y:c.y},L(t,c.x,c.y)||(m=!1)}return d}(r.EnemyCentroid,u);!function(e,t){for(var n=0,a=0,r=0;r<e.length;r++)"Tank"===e[r].unit.name&&0,"Infantry"===e[r].unit.name&&a++;for(var r=0;r<t.length;r++)"Tank"===t[r].unit.name&&0,"Infantry"===t[r].unit.name&&n++;w(t),w(e);if(n<=a&&0<a)return}(o,i);for(var s={x:l[0].x-l[1].x,y:l[0].y-l[1].y},c={x:l[l.length-1].x-l[l.length-2].x,y:l[l.length-1].y-l[l.length-2].y},d=l[0].x+s.x,y=l[0].y+s.y,f=l[l.length-1].x+c.x,m=l[l.length-1].y+c.y,p=0;p<o.length;p++){if(o[p].unit.canMove)if(0===o[p].unit.type||2===o[p].unit.type){if(!L(l,o[p].x,o[p].y))return null===(x=k(e,l))&&(x=b(e,l,s,c)),x=I(e,t,n,o[p],x),v(o[p],x,r)}else if(o[p].x!==d||o[p].y!==y||o[p].x===f&&o[p].y===m){var x=b(e,l,s,c);return x=I(e,t,n,o[p],x),v(o[p],x,r)}}return T()}function I(e,t,n,a,r){for(var o=E.AIPathFor(a,r,e,t,n),i=null,u=0,l=t[a.unit.type];u<o.length&&o[u].cost<=l.movementSpeed;)i=o[u],u++;return i}function k(e,t){for(var n=0;n<t.length;n++)if(void 0===e[t[n].x][t[n].y].unit||null===e[t[n].x][t[n].y].unit)return t[n];return null}function b(e,t,n,a){for(var r=0,o={x:t[0].x+n.x,y:t[0].y+n.y},i={x:t[t.length-1].x+a.x,y:t[t.length-1].y+a.y};r<20;){if(r%2==0){if(o.x<e.length&&0<=o.x&&o.y<e[o.x].length&&0<=o.y&&(void 0===e[o.x][o.y].unit||null===e[o.x][o.y].unit))return o;o={x:o.x+n.x,y:o.y+n.y}}else{if(i.x<e.length&&0<i.x&&i.y<e[i.x].length&&0<=i.y&&(void 0===e[i.x][i.y].unit||null===e[o.x][o.y].unit))return i;i={x:i.x+n.x,y:i.y+n.y}}r++}return null}function M(e,t,n,a,r,o,i){if(null===o)return T();for(var u=[],l=new Array(300),s=0;s<i.length;s++)u.push(E.AIPathFor(o,i[s],e,t,n)),l.length>u[s].length&&(l=u[s]);for(var c=l,d=null,y=0,f=t[o.unit.type];y<c.length&&c[y].cost<=f.movementSpeed;)d=c[y],y++;return v(o,d,r)}function A(e){if(void 0!==e&&0<e.length){for(var t=0,n=0,a=0;a<e.length;a++)t+=e[a].x,n+=e[a].y;t/=e.length,n/=e.length}return{x:o(t),y:o(n)}}function o(e){return Math.round(Number(e))}function w(e){for(var t=0,n=0;n<e.length;n++)t+=e[n].unit.health;return t}function L(e,t,n){for(var a=0;a<e.length;a++)if(e[a].x==t&&e[a].y==n)return!0;return!1}return{ACTION_TYPES:r,DIFFICULTY_LEVELS:{EASY:0,HARD:1},aiAction:function(e,t,n,a,r){return function(e,t,n,a,r){var o=[],i=[],u=0;null!==r&&void 0===r.doneMoving&&(r.doneMoving=!1);for(var l=0;l<e.length;l++)for(var s=0;s<e[l].length;s++)null!==e[l][s].unit&&(e[l][s].unit.team===h.TEAMS.PLAYER&&i.push({x:l,y:s,unit:e[l][s].unit,moves:E.movementCoordinatesFor({x:l,y:s},e,t,n)}),e[l][s].unit.team===h.TEAMS.AI&&o.push({x:l,y:s,unit:e[l][s].unit,moves:E.movementCoordinatesFor({x:l,y:s},e,t,n)}));if(null!==r&&void 0===r.EnemyCentroid&&(r.EnemyCentroid=A(i)),null!==r&&void 0===r.AICentroid&&(r.AICentroid=A(o)),null!==r&&void 0===r.UnitsCanAttack)for(var c=0;c<o.length;c++)o[c].unit.canMove&&0<E.attackCoordinatesFor(o[c],e,t,n).length&&u++;else u=r.UnitsCanAttack;r.UnitsCanAttack=u;for(var d=null,c=0;c<o.length;c++)if(o[c].unit.canMove){d=o[c];break}if(null===d)return T();var y=function(e,t,n,a,r,o){for(var i=0,u=0;u<r.length;u++){var l=E.attackCoordinatesFor(r[u],e,t,n);0<l.length&&i++}return i}(e,t,n,0,o);if(1<=y||1===o.length)return function(e,t,n,a,r,o,i,u){if(1===u&&1<o.length){if(1===a)return g(e,t,n,0,r,o,i);for(var l=null,s=0;s<o.length;s++)if(o[s].unit.canMove){l=o[s];break}if(null===l)return T();var c=E.attackCoordinatesFor(l,e,t,n);if(0<c.length){var d=E.movementCoordinatesFor(l,e,t,n),y=c[Math.floor(Math.random()*c.length)];d.push(l);var f=E.movementCoordinatesForAttackCoordinate(y,d),m=f[Math.floor(Math.random()*f.length)];return C(l,m,y,r)}return M(e,t,n,0,r,l,i)}var p=function(e,t,n,a,r,o,i){for(var u=null,l=0,s=null,c=null,d=0;d<o.length;d++)if(o[d].unit.canMove){var y=E.movementCoordinatesFor(o[d],e,t,n),f=E.attackCoordinatesFor(o[d],e,t,n);y.push({x:o[d].x,y:o[d].y});for(var m=0;m<f.length;m++){var p=e[f[m].x][f[m].y].unit.health;if(L(y,f[m].x-1,f[m].y)){var x=S.damageForAttack(o[d].unit,e[f[m].x][f[m].y].unit,e[f[m].x-1][f[m].y].terrain,e[f[m].x][f[m].y].terrain,t,n),v=0;l<(v=p<x?2e4/x:x)&&(l=v,s={x:f[m].x-1,y:f[m].y},c={x:f[m].x,y:f[m].y},u=o[d])}if(L(y,f[m].x+1,f[m].y)){var x=S.damageForAttack(o[d].unit,e[f[m].x][f[m].y].unit,e[f[m].x+1][f[m].y].terrain,e[f[m].x][f[m].y].terrain,t,n),v=0;l<(v=p<x?2e4/x:x)&&(l=v,s={x:f[m].x+1,y:f[m].y},c={x:f[m].x,y:f[m].y},u=o[d])}if(L(y,f[m].x,f[m].y+1)){var x=S.damageForAttack(o[d].unit,e[f[m].x][f[m].y].unit,e[f[m].x][f[m].y+1].terrain,e[f[m].x][f[m].y].terrain,t,n),v=0;l<(v=p<x?2e4/x:x)&&(l=v,s={x:f[m].x,y:f[m].y+1},c={x:f[m].x,y:f[m].y},u=o[d])}if(L(y,f[m].x,f[m].y-1)){var x=S.damageForAttack(o[d].unit,e[f[m].x][f[m].y].unit,e[f[m].x][f[m].y-1].terrain,e[f[m].x][f[m].y].terrain,t,n),v=0;l<(v=p<x?2e4/x:x)&&(l=v,s={x:f[m].x,y:f[m].y-1},c={x:f[m].x,y:f[m].y},u=o[d])}}}if(null===u){for(var h=null,g=0;g<o.length;g++)o[g].unit.canMove&&(h=o[g]);return null===h?T():M(e,t,n,0,r,h,i)}return C(u,s,c,r)}(e,t,n,0,r,o,i);return p}(e,t,n,a,r,o,i,y);var f=E.attackCoordinatesFor(d,e,t,n);if(0<f.length&&0===a){var m=E.movementCoordinatesFor(d,e,t,n),p=f[Math.floor(Math.random()*f.length)];m.push(d);var x=E.movementCoordinatesForAttackCoordinate(p,m),v=x[Math.floor(Math.random()*x.length)];return C(d,v,p,r)}return 1===a?g(e,t,n,0,r,o,i):M(e,t,n,0,r,d,i)}(e,t,n,a,r)}}}(app.util,app.pathfinder,app.unitStats,app.terrainStats,app.damage),(app=app||{}).saveGame=function(o){return{getSaves:function(){for(var e=[],t=0;t<localStorage.length;t++){var n=JSON.parse(localStorage.getItem(localStorage.key(t)));e.push({id:n.id,name:n.name,formattedDate:n.formattedDate,gameMetadata:n.gameMetadata})}return e.sort(function(e,t){return(e.formattedDate<t.formattedDate)-(e.formattedDate>t.formattedDate)}),0<e.length?e:null},getSave:function(e){return null!=localStorage.getItem(e)?JSON.parse(localStorage.getItem(e)):null},deleteSave:function(e){if(null!=localStorage.getItem(e))try{return localStorage.removeItem(e),!0}catch(e){return!1}return!1},createSave:function(e,t,n){var a=new Date,r=a.getFullYear(),o=a.getMonth()+1;o<10&&(o="0"+o);var i=a.getDate();i<10&&(i="0"+i);var u=a.getHours();u<10&&(u="0"+u);var l=a.getMinutes();l<10&&(l="0"+l);var s=a.getSeconds();s<10&&(s="0"+s);var c,d=r+"/"+o+"/"+i+" "+u+":"+l+":"+s;if(0==localStorage.length)c="capricornus0";else{var y=JSON.parse(localStorage.getItem(localStorage.key(localStorage.length-1))).id.substring(11),f=Number(y);c="capricornus"+ ++f}var m={id:c,name:e,gameboard:t,gameMetadata:n,formattedDate:d};try{return localStorage.setItem(c,JSON.stringify(m)),!0}catch(e){return!1}},serializeGameboard:function(e){for(var t=new Array(e.length),n=0;n<e.length;n++){var a=e[n];t[n]=new Array(a.length);for(var r=0;r<a.length;r++)t[n][r]={},t[n][r].unit=o.cloneObject(e[n][r].unit)}return t},userInfoToGameMetadata:function(e){var t={};return t.difficultyLevel=e.difficultyLevel,t.levelIndex=e.levelIndex,t.turnNum=e.turnNum,t}}}(app.util),(app=app||{}).menu=function(e,t,d,y,f,m){var n=!1;function a(){var e=d.getSaves();!e||e.length<=0?document.getElementById("menu_option_load_game").style.display="none":document.getElementById("menu_option_load_game").style.display="",document.documentElement.classList.remove("load-game-menu"),document.documentElement.classList.remove("difficulty-menu"),document.documentElement.classList.add("main-menu")}function u(t,n,a,r){function e(e){document.documentElement.classList.remove("difficulty-menu"),r(t,n,a,e)}var o=document.getElementById("difficulty-level-button-easy"),i=document.getElementById("difficulty-level-button-hard");o.onclick=function(){e(m.DIFFICULTY_LEVELS.EASY)},i.onclick=function(){e(m.DIFFICULTY_LEVELS.HARD)},document.documentElement.classList.remove("load-game-menu"),document.documentElement.classList.remove("main-menu"),document.documentElement.classList.add("difficulty-menu")}return e.forEach(document.querySelectorAll('[data-button-target="main-menu"]'),function(e,t){e.onclick=function(){a()}}),{initializeMainMenu:function(a,r,o){if(document.getElementById("menu_option_new_game").onclick=function(){u(a,r,0,o)},document.getElementById("menu_option_load_game").onclick=function(){!function(u,l,s){var e=d.getSaves(),t=document.getElementById("load-game-list");if(t.innerHTML="",e&&0!==e.length){var c=document.createDocumentFragment();e.forEach(function(t){var e=y.createElement("li"),n=y.createElement("div",null,"menu-item"),a=y.createElement("div",t.name),r=y.createElement("div",u[t.gameMetadata.levelIndex].name+" - "+t.formattedDate,"save-game-info"),o=y.createElement("div","Turn: "+(t.gameMetadata.turnNum+1)+" Difficulty: "+(t.gameMetadata.difficultyLevel===m.DIFFICULTY_LEVELS.HARD?"Hard":"Easy"),"save-game-info");n.appendChild(a),n.appendChild(r),n.appendChild(o);var i=y.createElement("div","Delete","menu-item menu-item-danger");n.onclick=function(){var e=d.getSave(t.id);document.documentElement.classList.remove("load-game-menu"),s(u,l,null,null,e)},i.onclick=function(){f.confirm("Are you sure you want to delete "+t.name+"?",function(){e.remove(),d.deleteSave(t.id)})},e.appendChild(n),e.appendChild(i),c.appendChild(e)}),t.appendChild(c)}}(a,r,o),document.documentElement.classList.remove("main-menu"),document.documentElement.classList.remove("difficulty-menu"),document.documentElement.classList.add("load-game-menu")},n){var e=document.getElementById("main-menu-list"),i=document.createDocumentFragment(),t=y.createElement("li","Random Setup");t.onclick=function(){u(a,r,-1,o)},i.appendChild(t),a.forEach(function(e,t){var n=y.createElement("li",e.name);n.onclick=function(){u(a,r,t,o)},i.appendChild(n)}),e.appendChild(i)}},displayMainMenu:a}}(app.util,app.levelStats,app.saveGame,app.templater,app.modal,app.ai),app.game=function(O,Y,P,G,H,e,W,X,j,J,z,V,K,Z,$){return{start:function c(d,y,e,t,n){function f(){C.musicBuffers.forEach(function(e){e&&V.stopSound(e,200)})}function a(e,t){var n=C.musicBuffers[t];n&&V.stopSound(n,300);var a=e+C.levelIndex*e,r=y.music[a].audio;C.musicBuffers[e]=V.playAudioBuffer(r,!1,null)}function r(){C.cursor.coordinate&&Y.eraseTile(B,C.cursor.coordinate)}function o(e){if(null!=C.cursor.coordinate){if(O.areCoordinatesEqual(C.cursor.coordinate,e))return;r()}C.cursor.coordinate=e,i()?Y.drawTile(B,F.cursor.attack.spritesheet,C.cursor.coordinate,F.cursor.attack.spriteCoordinate):Y.drawTile(B,F.cursor.select.spritesheet,C.cursor.coordinate,F.cursor.select.spriteCoordinate),C.unitSelected&&Y.gameTileForCoordinate(C.unitSelected,T).unit.team===P.TEAMS.PLAYER&&O.isCoordinateInMovementSquares(C.cursor.coordinate,C.unitSelectedMovementSquares)&&function(e){Y.eraseCanvas(D),Y.renderUnitMovementSquares(D,C.unitSelectedMovementSquares),Y.renderUnitAttackSquares(D,C.unitSelectedAttackSquares),Y.renderUnitSelectionOutline(D,C.unitSelected);var t=H.pathFor(C.unitSelected,e,T,L,U);C.unitSelectedShortestPath=t,Y.renderUnitMovementPreview(D,t)}(O.copyCoordinate(C.cursor.coordinate))}function i(){if(!C.unitSelected)return!1;var e=Y.gameTileForCoordinate(C.unitSelected,T).unit;return e.team===P.TEAMS.PLAYER&&e.canMove&&O.isCoordinateInMovementSquares(C.cursor.coordinate,C.unitSelectedAttackSquares)}function u(){C.buttonsEnabled=!0,C.gameInteractionEnabled=!0,o(C.currentMouseCoordinate),I.classList.remove("interaction-disabled"),[b,M,A].forEach(function(e){e.disabled=!1})}function m(){C.buttonsEnabled=!1,C.gameInteractionEnabled=!1,k.classList.remove("all-units-moved"),r(),C.cursor.coordinate=null,I.classList.add("interaction-disabled"),[b,M,A].forEach(function(e){e.disabled=!0})}function l(){(function(){for(var e=0;e<T.length;e++)for(var t=T[e],n=0;n<t.length;n++){var a=T[e][n].unit;if(a&&a.team===P.TEAMS.PLAYER&&a.canMove)return!0}return!1})()||k.classList.add("all-units-moved")}function s(e,t){Z.displayHeading(e,2500,function(){t()})}function p(e){a(P.TEAMS.PLAYER,P.TEAMS.AI),s("Turn "+(C.turnNum+1),e)}function x(e,t,n,a){var r=Y.gameTileForCoordinate(e,T).unit,o=Y.gameTileForCoordinate(e,T).terrain,i=Y.gameTileForCoordinate(t,T).unit,u=Y.gameTileForCoordinate(t,T).terrain;if(a)var l=X.damageForCounterattack(r,i,o,u,L,U);else l=X.damageForAttack(r,i,o,u,L,U);l>=i.health?(l=i.health,i.health=0,C.numUnits[i.team]--,Y.gameTileForCoordinate(t,T).unit=null):i.health-=l;var s=V.playAudioBuffer(y.units[r.type].attack);Y.renderAttack(_,D,e,t,r,i,l,function(){i.health<=0&&V.playAudioBuffer(y.units[i.type].die),setTimeout(function(){V.stopSound(s),!a&&0<i.health?x(t,e,n,!0):C.numUnits[P.TEAMS.PLAYER]<=0?(m(),f(),I.classList.remove("interaction-disabled"),V.playAudioBuffer(y.level.failed.audio),Z.displayMenu("Mission Failed","Restart mission",function(){c(d,y,C.levelIndex,C.difficultyLevel)})):C.numUnits[P.TEAMS.AI]<=0?(m(),f(),I.classList.remove("interaction-disabled"),V.playAudioBuffer(y.level.passed.audio),C.levelIndex<d.length-1?Z.displayMenu("Mission Complete","Next mission",function(){c(d,y,C.levelIndex+1,C.difficultyLevel)}):S(q,R,C.levelIndex+1)):n()},800)})}function v(e,t,n){var a=Y.gameTileForCoordinate(e,T).unit;if(O.areCoordinatesEqual(e,t))return a.canMove=!1,Y.redrawUnit(_,e,a),void n();var r=V.playAudioBuffer(y.units[a.type].move,!0),o=H.pathFor(e,t,T,L,U);Y.renderUnitMovement(_,D,a,o,function(){V.stopSound(r,300),Y.renderUnitMoved(_,t,a),a.canMove=!1,T[t.x][t.y].unit=a,T[e.x][e.y].unit=null,n()})}function h(){Y.eraseCanvas(D)}function g(){var e;e=function(){!function e(t,n){var a=W.aiAction(T,L,U,C.difficultyLevel,t);a.actionType!==W.ACTION_TYPES.END_TURN?a.actionType===W.ACTION_TYPES.ATTACK_UNIT?v(a.startingCoordinate,a.endingCoordinate,function(){x(a.endingCoordinate,a.attackedUnitCoordinate,function(){e(a.memoizationObject,n)})}):v(a.startingCoordinate,a.endingCoordinate,function(){e(a.memoizationObject,n)}):n()}({},function(){!function(){for(var e=0;e<T.length;e++)for(var t=T[e],n=0;n<t.length;n++)if(T[e][n].unit&&!T[e][n].unit.canMove){var a=T[e][n].unit;a.canMove=!0,Y.renderUnit(_,{x:e,y:n},a)}}(),C.turnNum++,p(function(){u()})})},a(P.TEAMS.AI,P.TEAMS.PLAYER),s("Computer Turn",e)}function E(e,t,n){if(C={cursor:{coordinate:null},currentMouseCoordinate:null,unitSelected:!1,unitSelectedMovementSquares:!1,unitSelectedAttackSquares:!1,unitSelectedShortestPath:!1,difficultyLevel:t,levelIndex:e,buttonsEnabled:!0,turnNum:0,musicBuffers:[null,null],gameInteractionEnabled:!0,numUnits:Object.keys(P.TEAMS).map(function(){return 0})},m(),e<0){var a=Math.floor(Math.random()*d.length);C.levelIndex=a,T=function(e){for(var t,n=d[e],a=new Array(w.x),r=0;r<w.x;r++)for(var o=0;o<w.y;o++){0==o&&(a[r]=new Array(w.y)),a[r][o]={};var i=j.terrainFor(n,r,o,w);a[r][o].terrain=i;var u=(t=void 0,(t=P.create(Math.floor(Math.random()*L.length),Math.floor(2*Math.random()))).health=Math.ceil(t.health*Math.random()),t.currentDirection=Math.floor(2*Math.random()),t);L[u.type].canTraverse[i.type]&&100*Math.random()<10?(a[r][o].unit=u,C.numUnits[u.team]++):a[r][o].unit=null}return a}(a);var r=d[a].spritesheet}else T=function(e){for(var t=new Array(w.x),n=0;n<w.x;n++)for(var a=0;a<w.y;a++){0==a&&(t[n]=new Array(w.y)),t[n][a]={},t[n][a].terrain=j.terrainFor(e,n,a,w);var r=j.unitFor(e.dataUnits[C.difficultyLevel],a,n,w);(t[n][a].unit=r)&&C.numUnits[r.team]++}return t}(d[e]),r=d[e].spritesheet;n&&(C.turnNum=n.gameMetadata.turnNum,function(e,t){C.numUnits=Object.keys(P.TEAMS).map(function(){return 0});for(var n=0;n<e.length;n++)for(var a=e[n],r=0;r<a.length;r++){var o=t[n][r].unit;(e[n][r].unit=o)&&C.numUnits[o.team]++}}(T,n.gameboard)),Y.renderLevel(N,r),Y.renderInitialGameboard(T,_)}function S(e,t,n){if(2<n)document.getElementById("level").innerHTML="Excellent work! We have reclaimed Capricornus Island. Now that we have taken back our home base, victory will surely be ours. I see a bright future ahead for you. Thanks for all your hard work, soldier!",document.getElementById("ready-btn").innerHTML="Return to Main Menu",e.style.display="block",t.onclick=function(){e.style.display="none",K.displayMainMenu()};else{if(0==n)var a="Welcome recruit to the legendary Capricornus Squadron. We’re glad to have you with us, as we’ve recently had some setbacks and have fallen on hard times. The enemy have taken over the Gemini Bridges, a vital position in our supply line, and we need to take it back. With your help we should be able to do so.</br></br>When attacking remember that infantry have advantages over planes, planes have advantages over tanks, and tanks have advantages over infantry. Also, infantry will take less damage if they are taking cover in mountains or trees. If you keep these things in mind you should be able to claim victory on the battlefield. Good luck out there soldier!";else 1==n?a="Well done soldier! Now that we have regained control of the Gemini Bridges we should be able to push through some much needed supplies. We can now make way to the port town of Aquarius - an integral location in the war. Currently the enemy have one of their main bases set up there. If we can overtake them, we should be well on our way to flipping the momentum in our favor.</br></br>Remember that only planes will be able to cross the water here. You can use this advantage to keep them out of harm's way until they are ready to strike. Alright, its time to move in. Keep up the good work.":2==n&&(a="Great going soldier! If you keep this up, you will be moving up the ranks in no time. We now have just one battle left. It is time to reclaim Capricornus Island. If we can take back what is rightfully ours from the enemies standing guard there, we will surely win the war and regain our legendary status as the greatest squadron in the world!</br></br>Just remember that attacking the nearest enemey may not always be the optimal decision. Sometimes it is better to attack an enemy that is further away if it will give you an advantage or just move away and take cover. Be wary of how far an enemy unit is from you and try to get the first strike on a unit.");document.getElementById("level").innerHTML=a,document.getElementById("ready-btn").innerHTML="READY",e.style.display="block",t.onclick=function(){e.style.display="none",p(function(){u()})}}}var T,C,I=document.getElementById("game-container"),k=document.getElementById("game-controls-container"),b=document.getElementById("button-end-turn"),M=document.getElementById("button-save-game"),A=document.getElementById("button-exit-game"),w=Y.totalTiles(I),L=P.get(),U=G.get(),F=$.get(),B=Y.getContext(I,"cursor-canvas"),D=Y.getContext(I,"unit-selection-canvas"),N=Y.getContext(I,"terrain-canvas"),_=Y.getContext(I,"unit-canvas"),q=document.getElementById("briefings"),R=document.getElementsByClassName("ready")[0];n?(E(n.gameMetadata.levelIndex,n.gameMetadata.difficultyLevel,n),p(function(){u()})):(E(e,t,n),S(q,R,C.levelIndex)),I.onmousemove=function(e){var t=Y.pixelCoordinateToTileCoordinate({x:e.offsetX,y:e.offsetY});C.currentMouseCoordinate=t,C.gameInteractionEnabled&&!O.areCoordinatesEqual(t,C.cursor.coordinate)&&o(t)},I.onclick=function(e){var t,n;if(C.buttonsEnabled)return C.unitSelected&&Y.gameTileForCoordinate(C.unitSelected,T).unit.team===P.TEAMS.PLAYER&&Y.gameTileForCoordinate(C.unitSelected,T).unit.canMove&&O.isCoordinateInMovementSquares(C.cursor.coordinate,C.unitSelectedMovementSquares)?(h(),t=C.unitSelected,n=O.copyCoordinate(C.cursor.coordinate),m(),V.playAudioBuffer(y.cursor.deselect.audio),v(t,n,function(){u(),l()}),void(C.unitSelected=!1)):i()?(h(),function(e,t,n){m();var a=C.unitSelectedMovementSquares.slice();a.push(e);var r=H.movementCoordinatesForAttackCoordinate(t,a);void 0!==n&&r.find(function(e){return O.areCoordinatesEqual(e,n)})||(n=O.isCoordinateInMovementSquares(e,r)?e:r[0]),V.playAudioBuffer(y.cursor.deselect.audio),v(e,n,function(){x(n,t,function(){u(),l()})})}(C.unitSelected,O.copyCoordinate(C.cursor.coordinate),C.unitSelectedShortestPath[C.unitSelectedShortestPath.length-1]),void(C.unitSelected=!1)):C.unitSelected?(V.playAudioBuffer(y.cursor.deselect.audio),C.unitSelected=!1,void h()):void(Y.gameTileForCoordinate(C.cursor.coordinate,T).unit&&Y.gameTileForCoordinate(C.cursor.coordinate,T).unit.canMove&&(C.unitSelected={x:C.cursor.coordinate.x,y:C.cursor.coordinate.y},function(e){var t=H.movementCoordinatesFor(e,T,L,U);C.unitSelectedMovementSquares=t;var n=H.attackCoordinatesFor(e,T,L,U);C.unitSelectedAttackSquares=n,Y.renderUnitMovementSquares(D,t),Y.renderUnitAttackSquares(D,n),Y.renderUnitSelectionOutline(D,e),V.playAudioBuffer(y.cursor.select.audio)}(C.unitSelected)))},b.onclick=function(){C.buttonsEnabled&&(m(),h(),C.unitSelected=!1,g())},M.onclick=function(){C.buttonsEnabled&&J.prompt("Enter a name for your save game",function(e){var t,n,a;t=e,n=z.serializeGameboard(T),a=z.userInfoToGameMetadata(C),z.createSave(t,n,a)?J.alert("Game saved"):J.alert("Saving game failed")})},A.onclick=function(){C.buttonsEnabled&&J.confirm("Are you sure you want to quit? All unsaved progress will be lost.",function(){f(),K.displayMainMenu()})}}}}(app.util,app.renderer,app.unitStats,app.terrainStats,app.pathfinder,app.levelStats,app.ai,app.damage,app.levelLoader,app.modal,app.saveGame,app.mixer,app.menu,app.textOverlay,app.uiStats),function(e,a,t,n,r,o,i){var u=t.get(),l=u.map(function(){return[null,null]}),s=[],c=i.get(),d=["select","deselect"],y=["passed","failed"],f=document.querySelectorAll("img.spritesheet"),m=f.length+3*u.length+3*c.units.length+d.length+y.length+c.music.length;function p(){0==--m&&(r.initializeLevelData(u,l,s),n.initializeMainMenu(u,c,e),n.displayMainMenu(),document.documentElement.classList.remove("loading"))}a.forEach(f,function(e){e.complete?p():e.onload=function(){p()}}),u.forEach(function(e,n){e.dataUnitsUrls.forEach(function(e,t){a.getJson(e,function(e){l[n][t]=e,p()})}),a.getJson(e.dataTerrainUrl,function(e){s[n]=e,p()})}),c.units.forEach(function(t){o.getAudioBuffer(t.moveUrl,function(e){t.move=e,p()}),o.getAudioBuffer(t.dieUrl,function(e){t.die=e,p()}),o.getAudioBuffer(t.attackUrl,function(e){t.attack=e,p()})}),d.forEach(function(e){var t=c.cursor[e];o.getAudioBuffer(t.url,function(e){t.audio=e,p()})}),y.forEach(function(e){var t=c.level[e];o.getAudioBuffer(t.url,function(e){t.audio=e,p()})}),c.music.forEach(function(t){o.getAudioBuffer(t.url,function(e){t.audio=e,p()})})}(app.game.start,app.util,app.levelStats,app.menu,app.levelLoader,app.mixer,app.audioStats);